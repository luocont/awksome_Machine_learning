# 随机森林算法示例

## 简介

本示例展示如何使用随机森林(Random Forest)算法进行二分类任务，具体场景是**贷款违约预测**。

随机森林是一种集成学习方法，通过构建多棵决策树并合并它们的预测结果来提高模型的准确性和稳定性。

## 数据集

使用生成的模拟贷款数据，包含以下特征：

- **年龄**: 申请人的年龄 (22-60岁)
- **收入**: 年收入 (15,000-100,000)
- **信用评分**: 信用评分 (550-800)
- **工作年限**: 当前工作年限 (0-20年)
- **负债率**: 负债比率 (0-0.6)
- **是否违约**: 目标变量 (0=正常, 1=违约)

数据集大小: 1000个样本
违约率: 约25%

## 文件说明

```
random_forest/
├── random_forest_example.py    # 主程序
├── random_forest_sample.csv    # 数据集
├── generate_data.py            # 数据生成脚本
└── README.md                   # 本文档
```

## 依赖安装

```bash
pip install numpy pandas scikit-learn matplotlib seaborn
```

可选: 用于生成GIF动画
```bash
pip install Pillow
```

## 使用方法

### 1. 运行完整示例

```bash
python random_forest_example.py
```

### 2. 生成新的数据集

```bash
python generate_data.py
```

## 程序功能

### 1. 数据加载与准备
- 从CSV文件加载贷款数据
- 划分训练集和测试集 (70%/30%)

### 2. 模型训练
- 训练随机森林分类器
- 参数配置:
  - n_estimators: 100 (树的数量)
  - max_depth: 10 (最大深度)
  - min_samples_split: 5 (最小分裂样本数)
  - min_samples_leaf: 2 (最小叶子节点样本数)

### 3. 模型评估
- 准确率 (Accuracy)
- ROC曲线和AUC值
- 混淆矩阵
- 分类报告 (精确率、召回率、F1分数)
- 5折交叉验证

### 4. 可视化

程序会生成以下可视化图表：

1. **ROC曲线** (`rf_roc_curve.png`)
   - 展示模型在不同阈值下的分类性能

2. **混淆矩阵** (`rf_confusion_matrix.png`)
   - 展示预测结果与真实标签的对比

3. **特征重要性** (`rf_feature_importance.png`)
   - 展示各特征对预测结果的重要性排序

4. **树数量分析** (`rf_n_estimators.png`)
   - 展示不同树数量对模型性能的影响

5. **随机森林原理图** (`rf_principle.png`)
   - 4个子图展示随机森林的核心概念：
     - Bootstrap采样
     - 决策树构建
     - 投票机制
     - 特征随机性

6. **决策边界** (`rf_decision_boundary.png`)
   - 展示模型在前两个特征上的决策边界

7. **特征分布** (`rf_feature_distributions.png`)
   - 展示各特征在不同类别下的分布情况

8. **随机森林动画** (`random_forest_animation.gif`)
   - 动态展示树数量增加时模型性能的变化

## 动画说明

随机森林动画展示了集成学习的核心思想：

- **左上图**: 决策边界随树数量增加的演化
  - 红色区域: 预测为违约
  - 蓝色区域: 预测为正常
  - 黑色线: 决策边界

- **右上图**: 准确率变化曲线
  - 红色线: 训练集准确率
  - 蓝色线: 测试集准确率
  - 星号: 当前树数量的准确率

- **左下图**: 损失变化曲线
  - 展示对数损失随树数量的变化
  - 用于评估模型预测概率的准确性

- **右下图**: 模型统计信息
  - 当前性能指标
  - 样本分布
  - 过拟合警告

## 随机森林原理

### 1. Bootstrap采样 (Bagging)
- 从原始数据集中有放回地随机抽取样本
- 每棵树使用不同的Bootstrap样本
- 增加模型的多样性

### 2. 随机特征选择
- 在每个节点分裂时，只考虑随机选择的部分特征
- 进一步增加树之间的差异
- 降低过拟合风险

### 3. 决策树构建
- 每棵树独立生长到最大深度或满足停止条件
- 不进行剪枝，保持树的复杂性

### 4. 集成预测 (投票)
- 分类问题: 多数投票
- 回归问题: 平均值
- 通过集成降低方差，提高泛化能力

## 随机森林优势

1. **高准确性**: 集成多棵决策树，提高预测准确性
2. **抗过拟合**: Bootstrap采样和随机特征选择降低过拟合风险
3. **特征重要性**: 可以评估各特征的重要性
4. **处理高维数据**: 能够处理大量特征
5. **鲁棒性强**: 对噪声和异常值不敏感
6. **并行化**: 可以并行训练多棵树

## 输出示例

```
随机森林算法示例 - 贷款违约预测
======================================================================

步骤1: 加载数据
======================================================================
数据加载成功: random_forest_sample.csv
数据形状: (1000, 6)

步骤2: 准备数据
======================================================================
特征列: ['年龄', '收入', '信用评分', '工作年限', '负债率']
样本数量: 1000
类别分布: 正常=750, 违约=250

步骤3: 划分训练集和测试集
======================================================================
训练集大小: 700
测试集大小: 300

步骤4: 训练随机森林模型
======================================================================
模型训练完成!
模型参数:
  - n_estimators: 100
  - max_depth: 10

步骤5: 评估模型
======================================================================
测试集准确率: 0.8767
ROC AUC: 0.9234

分类报告:
              precision    recall  f1-score   support

           0       0.89      0.96      0.92       225
           1       0.83      0.60      0.70        75

    accuracy                           0.88       300
   macro avg       0.86      0.78      0.81       300
weighted avg       0.87      0.88      0.87       300

步骤6: 交叉验证
======================================================================
5折交叉验证准确率: [0.865 0.875 0.860 0.880 0.870]
平均准确率: 0.8700 (+/- 0.0160)
```

## 参数调优建议

1. **n_estimators**: 树的数量
   - 默认: 100
   - 增加: 提高准确性，但训练时间更长
   - 建议: 100-500

2. **max_depth**: 树的最大深度
   - 默认: None (完全生长)
   - 建议: 10-20 (防止过拟合)

3. **min_samples_split**: 内部节点再划分所需最小样本数
   - 默认: 2
   - 建议: 5-10

4. **min_samples_leaf**: 叶子节点最小样本数
   - 默认: 1
   - 建议: 2-5

5. **max_features**: 寻找最佳分割时考虑的特征数量
   - 默认: "auto" (sqrt(n_features))
   - 选项: "auto", "log2", None, int

## 扩展阅读

- [Scikit-learn Random Forest Documentation](https://scikit-learn.org/stable/modules/ensemble.html#forests-of-randomized-trees)
- [Random Forest - Wikipedia](https://en.wikipedia.org/wiki/Random_forest)
- [Understanding Random Forest](https://towardsdatascience.com/understanding-random-forest-58381e0602d2)

## 注意事项

1. 随机森林不需要过多的数据预处理
2. 对缺失值不敏感
3. 可以处理数值型和分类型特征
4. 在高维空间中表现良好
5. 训练后可以提供特征重要性排序

## 许可证

MIT License
